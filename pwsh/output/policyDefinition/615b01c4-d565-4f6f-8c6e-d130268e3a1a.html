<!DOCTYPE html>
<!--[if lt IE 8 ]><html class="no-js ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="no-js ie ie8" lang="en"> <![endif]-->
<!--[if IE 9 ]><html class="no-js ie ie9" lang="en"> <![endif]-->
<!--[if (gte IE 8)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159063892-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-159063892-1');
    </script>

    <!--- Basic Page Needs
   ================================================== -->
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>AzPolicyAdvertizer</title>
    <meta name="description" content="AzAdvertizer insights on Azure Policy [Preview]: Configure backup for blobs storage accounts with a given tag to an existing backup vault in the same region">
    <meta name="author" content="Julian Hayward">

    <!-- mobile specific metas
   ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="../tablefilter/style/tablefilter_addon03.css">
    <link rel="stylesheet" href="../css/default_v16.css">
    <link rel="stylesheet" href="../css/layout_v7.css">
    <link rel="stylesheet" href="../css/media-queries_v3.css">
    <link rel="stylesheet" href="../css/table_v9.css">
    <link rel="stylesheet" href="../css/vs.css">
    <link rel="stylesheet" href="../css/jsondiffpatch/jsondiffpatch_addon003.css" type="text/css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../css/jsonviewer_v01.css">
    <script type="text/javascript" src="../js/jsonviewer_v01.js"></script>
    <!-- Favicons
	================================================== -->
    <link rel="shortcut icon" href="../favicon.png">

    <!-- Script
    ================================================== -->
    <!-- To collect end-user usage analytics about your application, insert the following script into each page you want to track. Place this code immediately before the closing </head> tag, and before any other scripts. Your first data will appear automatically in just a few seconds. --> 
    <script>var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"811aec69-c924-48af-84df-de30fb1d47d9" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    
    <!--<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="../tablefilter/tablefilter.js"></script>
    <script src="https://use.fontawesome.com/0c0b5cbde8.js"></script>
    <script src="../js/modernizr.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    </head>
    <body>

    <!-- Header
   ================================================== -->
   <header id="top">

        <div class="row">
            <div class="header-content twelve columns">
                <h1 id="logo-text"> 
                    <a>
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-cloud fa-stack-2x" style="color:#FFFFFF; margin-left:30px;"></i>
                            <span class="fa fa-stack-1x" style="color:#0078D4;">
                                    Az<font color="#34393A">Policy</font>Advertizer
                            </span>
                        </span>	   
                    </a>
                </h1>   
            </div>
        </div>

        <nav id="nav-wrap">
            <a class="mobile-btn" href="#nav-wrap" title="Show navigation">Show Menu</a>
            <a class="mobile-btn" href="#" title="Hide navigation">Hide Menu</a>

            <div class="row">
                <ul id="nav" class="nav">
                    <li><a href="../index.html">Home</a></li>
                    
        <li class="has-children current"><a href="../azpolicyadvertizer_all.html">Policy</a><ul><li><a href="../azpolicyadvertizer_history.html"><i class="fa fa-history" aria-hidden="true"></i> Changes</a></li><li><a href="../azpolicyadvertizer_all.html"><i class="fa fa-folder-o" aria-hidden="true"></i> All</a></li></ul></li>
        <li><a href="../azpolicyinitiativesadvertizer_all.html">Initiative</a><ul><li><a href="../azpolicyinitiativesadvertizer_history.html"><i class="fa fa-history" aria-hidden="true"></i> Changes</a></li><li><a href="../azpolicyinitiativesadvertizer_all.html"><i class="fa fa-folder-o" aria-hidden="true"></i> All</a></li></ul></li>
        <li><a href="../azpolicyaliasesadvertizer_history.html">Alias</a><ul><li><a href="../azpolicyaliasesadvertizer_history.html"><i class="fa fa-history" aria-hidden="true"></i> Changes</a></li><li><a href="../azpolicyaliasesadvertizer_all.html"><i class="fa fa-folder-o" aria-hidden="true"></i> All</a></li><li><a href="../azpolicyaliasesadvertizer_singlelines.html"><i class="fa fa-list" aria-hidden="true"></i> singleLines</a></li></ul></li>
        <li><a href="../azrolesadvertizer_all.html">RBAC Role</a><ul><li><a href="../azrolesadvertizer_history.html"><i class="fa fa-history" aria-hidden="true"></i> Changes</a></li><li><a href="../azrolesadvertizer_all.html"><i class="fa fa-folder-o" aria-hidden="true"></i> All</a></li></ul></li>
        <li><a href="../azresourceoperationadvertizer_all.html">ResProvOps</a></li>
        <!--<li><a href="../azaadrolesadvertizer_history.html">AAD Roles</a><ul><li><a href="../azaadrolesadvertizer_history.html"><i class="fa fa-history" aria-hidden="true"></i> Changes on AAD Roles</a></li><li><a href="../azaadrolesadvertizer_all.html"><i class="fa fa-folder-o" aria-hidden="true"></i> All AAD Roles</a></li></ul></li>-->
        
                    <li><a href="../other.html">Other</a></li>
                    <li><a href="../info.html" aria-label="Info"><i class="fa fa-info-circle fa-lg" aria-hidden="true"></i></a></li>
                </ul> <!-- end #nav -->
            </div>
        </nav> <!-- end #nav-wrap -->

    </header> <!-- Header End -->

    <!-- Content
   ================================================== -->
    <div id="content-wrap">
        <div class="row">
            <div id="main" class="eight columns">
                <article class="entry">
                <mark class="markdefault">last sync: 2021-Dec-29 17:45:20 UTC</mark>
                    <div class="entry-content">
                        <h3><i class="fa fa-search" aria-hidden="true"></i> Azure Policy definition</h3>
                        <h3>[Preview]: Configure backup for blobs storage accounts with a given tag to an existing backup vault in the same region</h3>             
                    </div>
                </article>
            </div> <!-- main End -->
            <div id="sidebar" class="four columns">
                <div class="widget widget_popular">
                    <!-- <h3>Popular</h3> -->
                    <ul class="link-list">
                        <li><i class="fa fa-folder-o" aria-hidden="true"></i> <a href="../azpolicyadvertizer_all.html">All Azure Policy definitions</a></li> 
                        <li><i class="fa fa-history" aria-hidden="true"></i> <a href="../azpolicyadvertizer_history.html">Changes on Azure Policy definitions</a></li>    
                    </ul>
                </div>
            </div> <!-- end sidebar -->
        </div> <!-- end row -->

        <div class="row add-bottom">
  
            <table class="detailTable">
                <tr>
                    <td class="wsnowrap">Name</td>
                    <td>[Preview]: Configure backup for blobs storage accounts with a given tag to an existing backup vault in the same region<br><a href="https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2F615b01c4-d565-4f6f-8c6e-d130268e3a1a" target="_blank"><i class="fa fa-cloud-upload" aria-hidden="true"></i> Azure Portal <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
                </tr>
                <tr>
                    <td class="wsnowrap">Id</td>
                    <td>615b01c4-d565-4f6f-8c6e-d130268e3a1a</td>
                </tr>
                <tr>
                    <td class="wsnowrap">Version</td>
                    <td>1.0.0-preview<br> <a href="https://github.com/Azure/azure-policy/tree/master/built-in-policies#versioning" target="_blank"><i class="fa fa-info-circle" aria-hidden="true"></i> details on versioning <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
                </tr>
                <tr>
                    <td class="wsnowrap">Category</td>
                    <td>Backup<br><a href="https://docs.microsoft.com/en-us/azure/governance/policy/samples/built-in-policies#backup" target="_blank" rel="noopener"><i class="fa fa-windows" aria-hidden="true"></i> Microsoft docs <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
                </tr>
                <tr>
                    <td class="wsnowrap">Description</td>
                    <td>Enforce backup for blobs on all storage accounts that do not contain a given tag to a central backup vault. Doing this can help you manage backup of blobs contained across multiple storage accounts at scale. For more details, refer to https://aka.ms/AB-BlobBackupAzPolicies</td>
                </tr>
                <tr>
                    <td class="wsnowrap">Mode</td>
                    <td>Indexed</td>
                </tr>
                <tr>
                    <td class="wsnowrap">Type</td>
                    <td><span style="font-weight: bold;">BuiltIn</span></td>
                </tr>
                <tr>
                    <td class="wsnowrap">Preview</td>
                    <td>                True
                    </td>
                </tr>
                <tr>
                    <td class="wsnowrap">Deprecated</td>
                    <td>                FALSE
                    </td>
                </tr>
                <tr>
                    <td class="wsnowrap">Effect</td>
                    <td>                        Default: DeployIfNotExists<br>
                        Allowed: (DeployIfNotExists, AuditIfNotExists, Disabled)                    </td>
                </tr>
                <tr>
                    <td class="wsnowrap">Used RBAC Role</td>
                    <td>                        <table class="filterTableAzPolicyAdvertizerDetailed">
                            <tr>
                                <td class="thsim">Role Name</td>
                                <td class="thsim">Role Id</td>
                            </tr>                            <tr>
                                <td>Backup Contributor</td>
                                <td><a href="../azrolesadvertizer/5e467623-bb1f-42f4-a55d-6e525e11384b.html" target="_blank">5e467623-bb1f-42f4-a55d-6e525e11384b</a></td>
                            </tr>                        </table>                    </td>
                </tr>

                <tr>
                    <td class="wsnowrap">Rule Aliases</td>
                    <td>                <span style="font-size: smaller"><b>IF (3)</b></span><br>
                <table class="filterTableAzPolicyAdvertizerDetailed">
                    <tr>
                        <td class="thsim">Alias</td>
                        <td class="thsim">Namespace</td>
                        <td class="thsim">ResourceType</td>
                        <td class="thsim">DefaultPath</td>
                        <td class="thsim">Modifiable</td>
                    </tr>                            <tr>
                                <td><a href="https://www.azadvertizer.net/azpolicyaliasesadvertizer_singlelines.html#%7B%22col_3%22%3A%7B%22flt%22%3A%22Microsoft.Storage%2fstorageAccounts%2fisHnsEnabled%22%7D%7D" target="_blank">Microsoft.Storage/storageAccounts/isHnsEnabled</a></td>
                                <td>Microsoft.Storage</td>
                                <td>storageAccounts</td>
                                <td>properties.isHnsEnabled</td>
                                <td>false</td>
                            </tr>                            <tr>
                                <td><a href="https://www.azadvertizer.net/azpolicyaliasesadvertizer_singlelines.html#%7B%22col_3%22%3A%7B%22flt%22%3A%22Microsoft.Storage%2fstorageAccounts%2fisNfsV3Enabled%22%7D%7D" target="_blank">Microsoft.Storage/storageAccounts/isNfsV3Enabled</a></td>
                                <td>Microsoft.Storage</td>
                                <td>storageAccounts</td>
                                <td>properties.isNfsV3Enabled</td>
                                <td>false</td>
                            </tr>                            <tr>
                                <td><a href="https://www.azadvertizer.net/azpolicyaliasesadvertizer_singlelines.html#%7B%22col_3%22%3A%7B%22flt%22%3A%22Microsoft.Storage%2fstorageAccounts%2fsku.tier%22%7D%7D" target="_blank">Microsoft.Storage/storageAccounts/sku.tier</a></td>
                                <td>Microsoft.Storage</td>
                                <td>storageAccounts</td>
                                <td>sku.tier</td>
                                <td>false</td>
                            </tr>                    </table>                <span style="font-size: smaller"><b>THEN-ExistenceCondition (1)</b></span><br>
                <table class="filterTableAzPolicyAdvertizerDetailed">
                    <tr>
                        <td class="thsim">Alias</td>
                        <td class="thsim">Namespace</td>
                        <td class="thsim">ResourceType</td>
                        <td class="thsim">DefaultPath</td>
                        <td class="thsim">Modifiable</td>
                    </tr>                            <tr>
                                <td><a href="https://www.azadvertizer.net/azpolicyaliasesadvertizer_singlelines.html#%7B%22col_3%22%3A%7B%22flt%22%3A%22Microsoft.Storage%2fstorageAccounts%2fblobServices%2fdefault.restorePolicy.enabled%22%7D%7D" target="_blank">Microsoft.Storage/storageAccounts/blobServices/default.restorePolicy.enabled</a></td>
                                <td>Microsoft.Storage</td>
                                <td>storageAccounts/blobServices</td>
                                <td>properties.restorePolicy.enabled</td>
                                <td>true</td>
                            </tr>                </table>                    </td>
                </tr>

                <tr>
                    <td class="wsnowrap">Rule ResourceTypes</td>
                    <td>                <span style="font-size: smaller"><b>IF (1)</b></span><br>                    Microsoft.Storage/StorageAccounts<br>                <span style="font-size: smaller"><b>THEN-Deployment (3)</b></span><br>                    Microsoft.Resources/deployments<br>                    Microsoft.Storage/storageAccounts<br>                    Microsoft.Storage/storageAccounts/blobServices<br>                    </td>
                </tr>

                <tr>
                    <td class="wsnowrap">History</td>
                    <td>                        <table class="filterTableAzPolicyAdvertizerDetailed">
                            <tr>
                                <td class="width15 thsim">Date/Time (UTC ymd) <abbr title="Date/Time represents the time of detection, changes may have occured earlier">(i)</abbr></td>
                                <td class="width15 thsim">Change type</td>
                                <td class="thsim">Change detail</td>
                            </tr>                            <tr>
                                <td>2021-12-06 22:17:57</td>
                                <td>add</td>
                                <td>615b01c4-d565-4f6f-8c6e-d130268e3a1a </td>
                            </tr>                        </table>                    </td>
                </tr>
                <tr>
                    <td class="wsnowrap">Used in Initiatives</td>
                    <td>                <i>none</i>                    </td>
                </tr>            <tr>
                <td class="wsnowrap">JSON</td>
                <td>
                    <table class="jsontdinnertable">
                        <tr>
                            <td class="jsontdinnertablehead">
                                <button onclick="copyDef()">Copy definition</button>
                                <script>
                                function copyDef() {
                                const obj = {
  "displayName": "[Preview]: Configure backup for blobs storage accounts with a given tag to an existing backup vault in the same region",
  "policyType": "BuiltIn",
  "mode": "Indexed",
  "description": "Enforce backup for blobs on all storage accounts that do not contain a given tag to a central backup vault. Doing this can help you manage backup of blobs contained across multiple storage accounts at scale. For more details, refer to https://aka.ms/AB-BlobBackupAzPolicies",
  "metadata": {
    "version": "1.0.0-preview",
    "preview": true,
    "category": "Backup"
  },
  "parameters": {
    "vaultLocation": {
      "type": "String",
      "metadata": {
        "displayName": "Location (Specify the location of the storage accounts that you want to protect)",
        "description": "Specify the location of the storage accounts that you want to protect. Blobs in the storage accounts should be backed up to a vault in the same location. For example - CanadaCentral",
        "strongType": "location"
      }
    },
    "backupPolicyId": {
      "type": "String",
      "metadata": {
        "displayName": "Backup Policy (of type Azure Blobs (Azure Storage) from a vault in the location chosen above)",
        "description": "Specify the ID of the backup policy to be used for configuring backup for blobs. The selected Azure Backup policy should be of type Azure Blobs (Azure Storage). This policy needs to be in a vault that is present in the location chosen above. For example - /subscriptions/<SubscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.DataProtection/vaults/<VaultName>/backupPolicies/<BackupPolicyName>. Also, make sure that this Backup vault's managed identity has the Storage Account Backup Contributor role assigned on the storage accounts for which backup is to be configured."
      }
    },
    "inclusionTagName": {
      "type": "String",
      "metadata": {
        "displayName": "Inclusion Tag Name",
        "description": "Name of the tag to use for including storage accounts in the scope of this policy. This should be used along with the Inclusion Tag Value parameter. Learn more at https://aka.ms/AB-BlobBackupAzPolicies"
      }
    },
    "inclusionTagValues": {
      "type": "Array",
      "metadata": {
        "displayName": "Inclusion Tag Values",
        "description": "Value of the tag to use for including storage accounts in the scope of this policy (in case of multiple values, use a comma-separated list). This should be used along with the Inclusion Tag Name parameter. Learn more at https://aka.ms/AB-BlobBackupAzPolicies."
      }
    },
    "effect": {
      "type": "String",
      "metadata": {
        "displayName": "Effect",
        "description": "Enable or disable the execution of the policy"
      },
      "allowedValues": [
        "DeployIfNotExists",
        "AuditIfNotExists",
        "Disabled"
      ],
      "defaultValue": "DeployIfNotExists"
    }
  },
  "policyRule": {
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Storage/StorageAccounts"
        },
        {
          "field": "[concat('tags[', parameters('inclusionTagName'), ']')]",
          "in": "[parameters('inclusionTagValues')]"
        },
        {
          "field": "kind",
          "equals": "StorageV2"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/sku.tier",
          "equals": "Standard"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/isHnsEnabled",
          "notEquals": "true"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/isNfsV3Enabled",
          "notEquals": "true"
        },
        {
          "field": "location",
          "equals": "[parameters('vaultLocation')]"
        }
      ]
    },
    "then": {
      "effect": "[parameters('effect')]",
      "details": {
        "type": "Microsoft.Storage/storageAccounts/blobServices",
        "name": "default",
        "existenceCondition": {
          "field": "Microsoft.Storage/storageAccounts/blobServices/default.restorePolicy.enabled",
          "equals": true
        },
        "roleDefinitionIds": [
          "/providers/Microsoft.Authorization/roleDefinitions/5e467623-bb1f-42f4-a55d-6e525e11384b"
        ],
        "deployment": {
          "properties": {
            "mode": "incremental",
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "backupPolicyId": {
                  "type": "string",
                  "metadata": {
                    "description": "Backup Policy Id"
                  }
                },
                "storageAccountResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "ResourceId of the Storage Account"
                  }
                },
                "location": {
                  "type": "string",
                  "metadata": {
                    "description": "Location for all resources"
                  }
                }
              },
              "variables": {
                "storageAccountName": "[first(skip(split(parameters('storageAccountResourceId'), '/'), 8))]",
                "dataSourceType": "Microsoft.Storage/storageAccounts/blobServices",
                "resourceType": "Microsoft.Storage/storageAccounts",
                "backupPolicyName": "[first(skip(split(parameters('backupPolicyId'), '/'), 10))]",
                "vaultName": "[first(skip(split(parameters('backupPolicyId'), '/'), 8))]",
                "vaultResourceGroup": "[first(skip(split(parameters('backupPolicyId'), '/'), 4))]",
                "vaultSubscriptionId": "[first(skip(split(parameters('backupPolicyId'), '/'), 2))]"
              },
              "resources": [
                {
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2021-04-01",
                  "resourceGroup": "[variables('vaultResourceGroup')]",
                  "subscriptionId": "[variables('vaultSubscriptionId')]",
                  "name": "[concat('DeployProtection-',uniqueString(variables('storageAccountName')))]",
                  "properties": {
                    "mode": "Incremental",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {},
                      "resources": [
                        {
                          "type": "Microsoft.DataProtection/backupvaults/backupInstances",
                          "apiVersion": "2021-01-01",
                          "name": "[concat(variables('vaultName'), '/', variables('storageAccountName'))]",
                          "properties": {
                            "objectType": "BackupInstance",
                            "dataSourceInfo": {
                              "objectType": "Datasource",
                              "resourceID": "[parameters('storageAccountResourceId')]",
                              "resourceName": "[variables('storageAccountName')]",
                              "resourceType": "[variables('resourceType')]",
                              "resourceUri": "[parameters('storageAccountResourceId')]",
                              "resourceLocation": "[parameters('location')]",
                              "datasourceType": "[variables('dataSourceType')]"
                            },
                            "policyInfo": {
                              "policyId": "[parameters('backupPolicyId')]",
                              "name": "[variables('backupPolicyName')]"
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              ]
            },
            "parameters": {
              "storageAccountResourceId": {
                "value": "[field('id')]"
              },
              "backupPolicyId": {
                "value": "[parameters('backupPolicyId')]"
              },
              "location": {
                "value": "[field('location')]"
              }
            }
          }
        }
      }
    }
  }
};
                                var copyText = JSON.stringify(obj);
                                navigator.clipboard.writeText(copyText);
                                }
                                </script>
                            </td>
                        </tr>
                        <tr>
                            <td class="jsontdinnertablecontent">
                                <div id="json" style="height: 600px;" ></div>
                                <script>
                                    var jsonObj = {};
                                    var jsonViewer = new JSONViewer();
                                    document.querySelector("#json").appendChild(jsonViewer.getContainer());
                                    var setJSON = function() {
                                        try {
                                            jsonObj = JSON.parse(JSON.stringify({
  "displayName": "[Preview]: Configure backup for blobs storage accounts with a given tag to an existing backup vault in the same region",
  "policyType": "BuiltIn",
  "mode": "Indexed",
  "description": "Enforce backup for blobs on all storage accounts that do not contain a given tag to a central backup vault. Doing this can help you manage backup of blobs contained across multiple storage accounts at scale. For more details, refer to https://aka.ms/AB-BlobBackupAzPolicies",
  "metadata": {
    "version": "1.0.0-preview",
    "preview": true,
    "category": "Backup"
  },
  "parameters": {
    "vaultLocation": {
      "type": "String",
      "metadata": {
        "displayName": "Location (Specify the location of the storage accounts that you want to protect)",
        "description": "Specify the location of the storage accounts that you want to protect. Blobs in the storage accounts should be backed up to a vault in the same location. For example - CanadaCentral",
        "strongType": "location"
      }
    },
    "backupPolicyId": {
      "type": "String",
      "metadata": {
        "displayName": "Backup Policy (of type Azure Blobs (Azure Storage) from a vault in the location chosen above)",
        "description": "Specify the ID of the backup policy to be used for configuring backup for blobs. The selected Azure Backup policy should be of type Azure Blobs (Azure Storage). This policy needs to be in a vault that is present in the location chosen above. For example - /subscriptions/<SubscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.DataProtection/vaults/<VaultName>/backupPolicies/<BackupPolicyName>. Also, make sure that this Backup vault's managed identity has the Storage Account Backup Contributor role assigned on the storage accounts for which backup is to be configured."
      }
    },
    "inclusionTagName": {
      "type": "String",
      "metadata": {
        "displayName": "Inclusion Tag Name",
        "description": "Name of the tag to use for including storage accounts in the scope of this policy. This should be used along with the Inclusion Tag Value parameter. Learn more at https://aka.ms/AB-BlobBackupAzPolicies"
      }
    },
    "inclusionTagValues": {
      "type": "Array",
      "metadata": {
        "displayName": "Inclusion Tag Values",
        "description": "Value of the tag to use for including storage accounts in the scope of this policy (in case of multiple values, use a comma-separated list). This should be used along with the Inclusion Tag Name parameter. Learn more at https://aka.ms/AB-BlobBackupAzPolicies."
      }
    },
    "effect": {
      "type": "String",
      "metadata": {
        "displayName": "Effect",
        "description": "Enable or disable the execution of the policy"
      },
      "allowedValues": [
        "DeployIfNotExists",
        "AuditIfNotExists",
        "Disabled"
      ],
      "defaultValue": "DeployIfNotExists"
    }
  },
  "policyRule": {
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Storage/StorageAccounts"
        },
        {
          "field": "[concat('tags[', parameters('inclusionTagName'), ']')]",
          "in": "[parameters('inclusionTagValues')]"
        },
        {
          "field": "kind",
          "equals": "StorageV2"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/sku.tier",
          "equals": "Standard"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/isHnsEnabled",
          "notEquals": "true"
        },
        {
          "field": "Microsoft.Storage/storageAccounts/isNfsV3Enabled",
          "notEquals": "true"
        },
        {
          "field": "location",
          "equals": "[parameters('vaultLocation')]"
        }
      ]
    },
    "then": {
      "effect": "[parameters('effect')]",
      "details": {
        "type": "Microsoft.Storage/storageAccounts/blobServices",
        "name": "default",
        "existenceCondition": {
          "field": "Microsoft.Storage/storageAccounts/blobServices/default.restorePolicy.enabled",
          "equals": true
        },
        "roleDefinitionIds": [
          "/providers/Microsoft.Authorization/roleDefinitions/5e467623-bb1f-42f4-a55d-6e525e11384b"
        ],
        "deployment": {
          "properties": {
            "mode": "incremental",
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "backupPolicyId": {
                  "type": "string",
                  "metadata": {
                    "description": "Backup Policy Id"
                  }
                },
                "storageAccountResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "ResourceId of the Storage Account"
                  }
                },
                "location": {
                  "type": "string",
                  "metadata": {
                    "description": "Location for all resources"
                  }
                }
              },
              "variables": {
                "storageAccountName": "[first(skip(split(parameters('storageAccountResourceId'), '/'), 8))]",
                "dataSourceType": "Microsoft.Storage/storageAccounts/blobServices",
                "resourceType": "Microsoft.Storage/storageAccounts",
                "backupPolicyName": "[first(skip(split(parameters('backupPolicyId'), '/'), 10))]",
                "vaultName": "[first(skip(split(parameters('backupPolicyId'), '/'), 8))]",
                "vaultResourceGroup": "[first(skip(split(parameters('backupPolicyId'), '/'), 4))]",
                "vaultSubscriptionId": "[first(skip(split(parameters('backupPolicyId'), '/'), 2))]"
              },
              "resources": [
                {
                  "type": "Microsoft.Resources/deployments",
                  "apiVersion": "2021-04-01",
                  "resourceGroup": "[variables('vaultResourceGroup')]",
                  "subscriptionId": "[variables('vaultSubscriptionId')]",
                  "name": "[concat('DeployProtection-',uniqueString(variables('storageAccountName')))]",
                  "properties": {
                    "mode": "Incremental",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {},
                      "resources": [
                        {
                          "type": "Microsoft.DataProtection/backupvaults/backupInstances",
                          "apiVersion": "2021-01-01",
                          "name": "[concat(variables('vaultName'), '/', variables('storageAccountName'))]",
                          "properties": {
                            "objectType": "BackupInstance",
                            "dataSourceInfo": {
                              "objectType": "Datasource",
                              "resourceID": "[parameters('storageAccountResourceId')]",
                              "resourceName": "[variables('storageAccountName')]",
                              "resourceType": "[variables('resourceType')]",
                              "resourceUri": "[parameters('storageAccountResourceId')]",
                              "resourceLocation": "[parameters('location')]",
                              "datasourceType": "[variables('dataSourceType')]"
                            },
                            "policyInfo": {
                              "policyId": "[parameters('backupPolicyId')]",
                              "name": "[variables('backupPolicyName')]"
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              ]
            },
            "parameters": {
              "storageAccountResourceId": {
                "value": "[field('id')]"
              },
              "backupPolicyId": {
                "value": "[parameters('backupPolicyId')]"
              },
              "location": {
                "value": "[field('location')]"
              }
            }
          }
        }
      }
    }
  }
}));
                                        }
                                        catch (err) {
                                            alert(err);
                                        }
                                    };
                                    setJSON();
                                    jsonViewer.showJSON(jsonObj)

                                </script>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>        </div> <!-- Row End-->
    </div> <!-- Row End-->

    <!-- Footer
    ================================================== -->
    <footer>
        <div class="row">
            <div class="six columns info">
                <p>Please note that while being developed by a Microsoft employee, AzAdvertizer is not a Microsoft
                    service or product. AzAdvertizer is a personal driven project, there are none implicit or
                    explicit obligations related to this project, it is provided 'as is' with no warranties and
                    confer no rights.<br>
                </p>

            </div>
            <div class="six columns info">
            <p>JH <a href="https://www.linkedin.com/in/julianhayward" target="_blank" rel="noopener" aria-label="LinkedIn"><i
            class="fa fa-linkedin-square fa-lg" aria-hidden="true"></i></a></p>
            </div>
        </div>
        <div id="go-top">
            <a class="smoothscroll" title="Back to Top" href="#top"><i class="fa fa-chevron-up"></i></a>
        </div>
    </footer> <!-- End Footer-->

    <!-- Java Script
    ================================================== -->
    <!--<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
    <script src="../js/main.js"></script>
</body>

</html>
